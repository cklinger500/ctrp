
<div class="row">
    <uib-accordion close-others="false">
        <uib-accordion-group is-open="paTrialOverview.accordionOpen">
            <uib-accordion-heading>
                Associated Trials <i class="pull-right glyphicon" ng-class="{'glyphicon-chevron-down': paTrialOverview.accordionOpen, 'glyphicon-chevron-right': !paTrialOverview.accordionOpen}"></i>
            </uib-accordion-heading>
            <!-- add associated trial -->
            <div class="row top-buffer">
                <form name="associated_trials_form" role="form" class="form-horizontal" novalidate ctrp-submit="assoTrialsView.lookupTrial()">
                    <!-- fieldset for eligibility criteria -->
                    <fieldset class="sub-bordered" restriction-field ng-disabled="!paTrialOverview.trialDetailObj.pa_sci_editable" ng-show="assoTrialsView.showLookupForm">
                        <legend class="sub-bordered">
                            Trial Lookup
                        </legend>
                        <div class="form-group" ng-class="{'has-feedback required': true, 'has-error': ctrpbtn.associated_trials_form.needsAttention(associated_trials_form.identifier_type)}">
                            <label for="identifier_type" class="control-label col-xs-12 col-sm-3">Identifier Type:</label>
                            <div class="col-xs-12 col-sm-4">
                                <select name="identifier_type" id="identifier_type" class="form-control input-sm"
                                    ng-model="assoTrialsView.trialQueryObj.identifierTypeId"
                                    ng-options="type.id as type.name for type in assoTrialsView.identifierTypes"
                                    ng-required="true"
                                >
                                    <option value="">
                                        -- Please select a trial identifier type...
                                    </option>
                                </select>
                                <span ng-messages="ctrpbtn.associated_trials_form.needsAttention(associated_trials_form.identifier_type) &&
                                                    associated_trials_form.identifier_type.$error">
                                    <span class="help-block" ng-message="required"><br />Identifier Type is Required</span>
                               </span>
                            </div>
                        </div>
                        <div class="form-group" ng-class="{'has-feedback required': true, 'has-error': ctrpbtn.associated_trials_form.needsAttention(associated_trials_form.trial_identifier)}">
                            <label for="trial_identifier" class="control-label col-xs-12 col-sm-3">Trial Identifier:</label>
                            <div class="col-xs-12 col-sm-4">
                                <input type="text" name="trial_identifier" id="trial_identifier"
                                    class="form-control input-sm"
                                    ng-model="assoTrialsView.trialQueryObj.trialIdentifier"
                                    required
                                    placeholder="Trial Identifier"
                                >
                                <span ng-messages="ctrpbtn.associated_trials_form.needsAttention(associated_trials_form.trial_identifier) &&
                                                    associated_trials_form.trial_identifier.$error">
                                    <span class="help-block" ng-message="required"><br />Trial Identifier is Required</span>
                               </span>
                            </div>
                            <div class="col-xs-12 col-sm-2">
                                <button type="submit" class="btn btn-primary"
                                    ng-disabled="assoTrialsView.lookupBtnDisabled">
                                    <i class="glyphicon glyphicon-search"></i> Look Up Trial
                                </button>
                            </div>
                            <div class="col-xs-12 col-sm-2 form-text alert alert-warning" ng-show="assoTrialsView.foundTrialObj.errorMsg.length > 0">
                                {{assoTrialsView.foundTrialObj.errorMsg}}
                            </div>
                        </div>
                        <div ng-hide="assoTrialsView.foundTrialObj.official_title.length==0">
                            <!-- show this div only if the trial is found not null -->
                            <div class="form-group">
                                <label class="control-label col-xs-12 col-sm-3">Research Category</label>
                                <div class="col-xs-12 col-sm-5 form-text">{{assoTrialsView.foundTrialObj.researchCategory}}</div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-xs-12 col-sm-3">Official Title</label>
                                <div class="col-xs-12 col-sm-9 form-text">{{assoTrialsView.foundTrialObj.official_title}}</div>
                            </div>

                            <div class="form-group text-center">
                                <button type="button" class="btn btn-warning" ng-click="assoTrialsView.resetTrialLookupForm(associated_trials_form)">Reset</button>
                                <button type="button" class="btn btn-primary" ng-click="assoTrialsView.associateTrial(assoTrialsView.foundTrialObj)">Associate</button>
                                <span class="help-block">{{assoTrialsView.associationErrorMsg}}</span>
                            </div>
                        </div>
                    </fieldset>

                </form>
            </div>
            <!-- end of adding associated trial -->
            <!-- associated trials -->
            <div class="row top-buffer">
                <form>
                    <fieldset class="sub-bordered" restriction-field ng-disabled="!paTrialOverview.trialDetailObj.pa_sci_editable">
                        <legend class="sub-bordered">Associated Trials</legend>
                        <div class="row">
                            <span ng-show="assoTrialsView.trialDetailObj.associated_trials.length === 0">Nothing found to display</span>
                        </div>
                        <div class="row top-buffer">
                            <table st-table="assoTrialsView.trialDetailObj.associated_trials" class="table table-striped table-hover table-bordered" ng-hide="assoTrialsView.trialDetailObj.associated_trials.length === 0">
                                <thead>
                                <tr>
                                    <th class="col-sm-2 text-center">Trial Identifier</th>
                                    <th class="col-sm-1 text-center">Identifier Type</th>
                                    <th class="text-center col-sm-1">Trial Type</th>
                                    <th class="text-center col-sm-4">Official Title</th>
                                    <th class="text-center col-sm-2"><input type="checkbox" name="delete_all_asso" id="delete_all_asso" ng-model="assoTrialsView.deleteAllAssoCheckbox" ng-change="assoTrialsView.deleteAllAssociations(assoTrialsView.deleteAllAssoCheckbox)"></th>
                                </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="t in assoTrialsView.trialDetailObj.associated_trials track by $index" ng-class="t._destroy ? 'deleted-text' : ''">
                                        <td class="text-center">
                                            <span ng-show="t.trial_identifier.indexOf('NCI') > -1">
                                                <a ui-sref="main.viewTrial({trialId: t.associated_trial_id})">{{t.trial_identifier}}</a>
                                            </span>
                                            <span ng-show="t.trial_identifier.indexOf('NCI') === -1">
                                                <a href="https://clinicaltrials.gov/ct2/show/{{t.trial_identifier}}" target="_blank">{{t.trial_identifier}}</a>
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            {{t.identifierTypeStr}}
                                        </td>
                                        <td class="text-center">
                                            {{t.research_category_name}}
                                        </td>
                                        <td>
                                            {{t.official_title}}
                                        </td>
                                        <td class="text-center td-icon">
                                            <input type="checkbox" ng-model="t._destroy" ng-change="!t._destroy" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="row top-buffer" ng-show="paTrialOverview.trialDetailObj.pa_sci_editable">
                <div class="col-sm-3"></div>
                <div class="btn-toolbar col-xs-12 col-sm-9">
                  <!-- <button type="button" class="btn btn-primary pull-right" id="save_btn" restriction-field ng-click="assoTrialsView.updateTrialAssociations()">
                    <i class="glyphicon glyphicon-ok"></i>  Save
                  </button> -->
                  <button type="button" class="btn btn-primary pull-right" ng-click="assoTrialsView.showTrialLookupForm(associated_trials_form)">
                      <i class="glyphicon glyphicon-plus"></i> Add a Trial
                  </button>
                  <button type="button" class="btn btn-danger pull-right" id="cancel_btn"
                      restriction-field
                      ng-click="assoTrialsView.deleteTrialAssociations()"
                      ng-show="assoTrialsView.trialDetailObj.associated_trials.length > 0"
                      ng-disabled="assoTrialsView.deleteBtnDisabled">
                   <i class="glyphicon glyphicon-remove"></i>  Delete Associated Trials
                  </button>
                </div>
            </div>
            <!-- end of associated trials -->
            </uib-accordion-group>
      </uib-accordion>
</div>
